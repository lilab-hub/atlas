name: Deploy Atlas to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOCKER_IMAGE: atlas
  DOCKER_TAG: latest
  CONTAINER_NAME: atlas
  SERVER_HOST: 161.132.48.57
  SERVER_USER: root
  DEPLOY_PATH: /root/atlas
  DOCKER_COMPOSE_FILE: docker-compose.prod.yml
  NEXT_PUBLIC_API_URL: https://atlas.lilab.pe

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: test
    environment: Production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build \
            --build-arg NEXT_PUBLIC_API_URL=${{ env.NEXT_PUBLIC_API_URL }} \
            -t ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} .

      - name: Save Docker image
        run: |
          docker save ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} | gzip > atlas-image.tar.gz

      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Upload Docker image to server
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no atlas-image.tar.gz ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:/tmp/

      - name: Deploy on server
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            set -e

            echo "Loading Docker image..."
            docker load < /tmp/atlas-image.tar.gz

            echo "Stopping existing container..."
            docker stop ${{ env.CONTAINER_NAME }} || true
            docker rm ${{ env.CONTAINER_NAME }} || true

            echo "Starting new container..."
            cd ${{ env.DEPLOY_PATH }}
            docker compose -f ${{ env.DOCKER_COMPOSE_FILE }} up -d atlas

            echo "Cleaning up..."
            rm /tmp/atlas-image.tar.gz
            docker image prune -f

            echo "Deployment completed successfully!"

            echo "Container status:"
            docker ps | grep ${{ env.CONTAINER_NAME }}
          ENDSSH

      - name: Health check
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            sleep 10
            if docker ps | grep -q ${{ env.CONTAINER_NAME }}; then
              echo "Container is running!"
              docker logs --tail 50 ${{ env.CONTAINER_NAME }}
            else
              echo "Container failed to start!"
              exit 1
            fi
          ENDSSH

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: always()

    steps:
      - name: Deployment Success
        if: needs.build-and-deploy.result == 'success'
        run: |
          echo "Deployment to production was successful!"
          echo "Project: Atlas"
          echo "Branch: main"
          echo "Commit: ${{ github.sha }}"
          echo "API URL: ${{ env.NEXT_PUBLIC_API_URL }}"

      - name: Deployment Failed
        if: needs.build-and-deploy.result != 'success'
        run: |
          echo "Deployment failed!"
          exit 1
